- topics.each do |topic|
  - row_classes = ["topic-row"]
  - row_classes << "has-core-team-activity" if topic.has_core_team_activity?
  - row_classes << "has-committer-activity" if !topic.has_core_team_activity? && topic.has_committer_activity?
  - row_classes << "has-contributor-activity" if !topic.has_core_team_activity? && !topic.has_committer_activity? && topic.has_contributor_activity?
  tr class=row_classes.join(" ") data-topic-id=topic.id data-last-message-id=topic.messages.maximum(:id)
    td.topic-title data-label="Topic"
      - has_attachments = @topic_states&.dig(topic.id, :has_attachments)
      - if has_attachments
        span.topic-attachment-icon title="Has attachments" aria-label="Has attachments" ğŸ“
      = link_to topic.title, topic_path(topic), class: "topic-link"
    td.topic-participants data-label="Participants"
      .topic-participants
        .participants-avatars
          - participants = topic.participant_aliases(limit: 5)
          - participants.each_with_index do |participant, index|
            - is_creator = (participant.id == topic.creator.id)
            - last_message = topic.messages.order(:created_at).last
            - is_last_poster = (participant.id == last_message&.sender_id)
            - css_classes = ["participant-avatar"]
            - css_classes << "is-creator" if is_creator
            - css_classes << "is-last-poster" if is_last_poster
            - css_classes << "is-core-team" if participant.core_team?
            - css_classes << "is-committer" if !participant.core_team? && participant.committer?
            - css_classes << "is-major-contributor" if !participant.core_team? && !participant.committer? && participant.major_contributor?
            - css_classes << "is-significant-contributor" if !participant.core_team? && !participant.committer? && !participant.major_contributor? && participant.significant_contributor?
            - css_classes << "is-past-contributor" if participant.contributor&.past_contributor?
            - badge_text = participant.contributor_badge ? "#{participant.name} (#{participant.contributor_badge})" : participant.name
            = image_tag participant.gravatar_url(size: 32), class: css_classes.join(" "), alt: participant.name, title: badge_text
        - total_participants = topic.messages.select(:sender_id).distinct.count
        - if total_participants > participants.count
          span.participants-count +#{total_participants - participants.count}
    td.topic-activity data-label="Replies / Activity"
      - last_message = topic.messages.order(:created_at).last
      .activity-info
        .activity-replies = "#{topic.messages.count - 1} replies"
        .activity-time = smart_time_display(last_message.created_at)
    - if user_signed_in?
      - state = @topic_states&.dig(topic.id) || {}
      - status = state[:status]
      - progress = state[:progress]
      - team_readers = state[:team_readers] || []
      - filtered_readers = team_readers
      - if params[:team_id].present?
        - filtered_readers = team_readers.select { |r| r[:team_ids]&.include?(params[:team_id].to_i) }
      td.topic-status data-label="Status"
        - case status
        - when :read
          span.status-pill.is-read title="Read"
            span.status-shape 100
        - when :reading
          - pct = ((progress || 0) * 100).round
          span.status-pill.is-reading title="Reading"
            span.status-shape = "#{pct}%"
        - when :aware
          span.status-pill.is-aware title="Aware"
            span.status-shape
        - else
          span.status-pill.is-new title="New"
            span.status-shape !
        - note_count = user_signed_in? ? @topic_note_counts&.dig(topic.id).to_i : 0
        - if note_count.positive?
          .note-status title="#{note_count} note(s) visible to you"
            span.note-icon ğŸ“
            span.note-count = note_count
        - if filtered_readers.any?
          .team-reader-avatars
            - filtered_readers.each do |reader|
              - alias_record = reader[:user].primary_alias || reader[:user].aliases.first
              - gravatar_name = alias_record&.name || "User ##{reader[:user].id}"
              - next unless alias_record
              - avatar_url = alias_record.gravatar_url(size: 20)
              - title_text = "#{gravatar_name} (#{reader[:status]})"
              = image_tag avatar_url, class: ["team-reader-avatar", ("is-read" if reader[:status] == :read), ("is-reading" if reader[:status] == :reading)].compact.join(" "), alt: alias_record.name, title: title_text
