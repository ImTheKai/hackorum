version: "3.9"

services:
  db:
    image: postgres:18
    entrypoint: ["/usr/local/bin/custom-entrypoint.sh"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-hackorum}
    volumes:
      # Postgres 18+ stores data under /var/lib/postgresql/<major>/main
      - pgdata:/var/lib/postgresql
      - pgwal:/var/lib/postgresql/wal-archive
      - pgbackups:/backups
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro # copy from postgresql.conf.example
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/entrypoint.sh:/usr/local/bin/custom-entrypoint.sh:ro
    command:
      [
        "postgres",
        "-c", "config_file=/etc/postgresql/postgresql.conf"
      ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-hackorum}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      autoheal: "true"

  web:
    build: ..
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-hackorum}}
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-postgres}
      PGPASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATABASE: ${POSTGRES_DB:-hackorum}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
    depends_on:
      db:
        condition: service_healthy
    expose:
      - "3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/up || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      autoheal: "true"

  imap_worker:
    build: ..
    command: ["bundle", "exec", "ruby", "script/imap_idle.rb"]
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-hackorum}}
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-postgres}
      PGPASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATABASE: ${POSTGRES_DB:-hackorum}
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "ps -ef | grep -v grep | grep -q imap_idle.rb"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      autoheal: "true"

  caddy:
    image: caddy:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      web:
        condition: service_started
    restart: unless-stopped

  autoheal:
    image: willfarrell/autoheal
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal
      AUTOHEAL_INTERVAL: 30
      AUTOHEAL_START_PERIOD: 60
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  mail:
    image: boky/postfix:latest
    hostname: ${MAIL_HOSTNAME:-mail.example.com}
    environment:
      # Domain from which emails will be sent
      ALLOWED_SENDER_DOMAINS: ${MAIL_DOMAIN:-example.com}

      # Relay host (leave empty for direct sending, or use a relay like SendGrid/Mailgun)
      # RELAYHOST: ${MAIL_RELAYHOST:-}
      # RELAYHOST_USERNAME: ${MAIL_RELAYHOST_USERNAME:-}
      # RELAYHOST_PASSWORD: ${MAIL_RELAYHOST_PASSWORD:-}

      # DKIM signing
      DKIM_SELECTOR: ${DKIM_SELECTOR:-mail}
      DKIM_AUTOGENERATE: "true"

      # Logging
      LOG_LEVEL: ${MAIL_LOG_LEVEL:-info}

      # Override from address (optional, for testing)
      # OVERWRITE_FROM: ${MAIL_OVERWRITE_FROM:-}

      # TLS configuration
      TLS: "true"

      # Allow localhost relay (for the web container)
      ALLOW_EMPTY_SENDER_DOMAINS: "false"

      # Message size limit (default 10MB)
      MESSAGE_SIZE_LIMIT: ${MAIL_MESSAGE_SIZE_LIMIT:-10240000}
    volumes:
      # Persist DKIM keys
      - mail_dkim:/etc/opendkim/keys
      # Persist mail queue
      - mail_spool:/var/spool/postfix
    expose:
      - "587"  # Submission port (for authenticated clients)
    ports:
      - "25:25"   # SMTP port (for receiving mail)
    healthcheck:
      test: ["CMD-SHELL", "postfix status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      autoheal: "true"

  psql:
    image: postgres:18
    entrypoint: ["psql", "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-hackorum}"]
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
    profiles: ["tools"]

volumes:
  pgdata:
  pgwal:
  pgbackups:
  caddy_data:
  caddy_config:
  mail_dkim:
  mail_spool:
